// ============================================
// Bander Project - Integrated MSA ERD
// 서비스 간 논리적 관계 포함
// Generated: 2026-01-12
// dbdiagram.io - https://dbdiagram.io
// ============================================

// ============================================
// CORE: AUTH SERVICE (인증 - 모든 서비스의 기준점)
// ============================================

Table auth {
  id varchar [pk, note: 'Snowflake ID - 모든 서비스에서 user_id로 참조']
  email varchar [unique]
  password varchar
  phone_number varchar
  provider varchar [note: 'KAKAO, GOOGLE, APPLE, LOCAL']
  status varchar [note: 'ACTIVE, INACTIVE, SUSPENDED, WITHDRAWN']
  user_role varchar [note: 'USER, ADMIN, PLACE_OWNER']
  version bigint
  created_at timestamp
  updated_at timestamp
}

Table auth_consent {
  id varchar [pk]
  user_id varchar [ref: > auth.id]
  consent_id varchar [ref: > consents_table.id]
  consented_at timestamp
}

Table consents_table {
  id varchar [pk]
  consent_name varchar
  required boolean
}

Table auth_history {
  id varchar [pk]
  user_id varchar [ref: > auth.id]
  updated_at timestamp
  updated_column varchar
  before_value varchar
  after_value varchar
}

Table withdraw {
  id varchar [pk]
  user_id varchar [unique, ref: - auth.id]
  reason varchar
  withdrawn_at timestamp
}

Table suspend {
  id varchar [pk]
  user_id varchar [ref: > auth.id]
  reason varchar
  suspended_at timestamp
  suspended_until timestamp
}

Table login_status {
  id varchar [pk]
  user_id varchar [unique, ref: - auth.id]
  last_login_at timestamp
  login_ip varchar
}

// ============================================
// PROFILE SERVICE
// ============================================

Table user_info {
  user_id varchar [pk, ref: - auth.id, note: 'Auth.id와 1:1 관계']
  profile_image_url varchar
  nickname varchar [unique]
  sex char
  city varchar
  introduction text
  is_public boolean
  is_chatable boolean
  version bigint
  created_at timestamp
  updated_at timestamp
}

Table user_genres {
  user_id varchar [pk, ref: > user_info.user_id]
  genre_id bigint [pk, ref: > genre_name_table.id]
}

Table genre_name_table {
  id bigint [pk, increment]
  genre_name varchar [unique]
}

Table user_instruments {
  user_id varchar [pk, ref: > user_info.user_id]
  instrument_id bigint [pk, ref: > instrument_name_table.id]
}

Table instrument_name_table {
  id bigint [pk, increment]
  instrument_name varchar [unique]
}

// ============================================
// PLACE INFO SERVICE
// ============================================

Table place_info {
  id bigint [pk, note: 'Snowflake ID']
  user_id varchar [ref: > auth.id, note: '업체 소유자 - Auth 서비스 참조']
  place_name varchar
  description text
  category varchar
  place_type varchar
  is_active boolean
  approval_status varchar [note: 'PENDING, APPROVED, REJECTED']
  rating_average decimal
  review_count int
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp
}

Table place_contact {
  id bigint [pk, increment]
  place_id bigint [unique, ref: - place_info.id]
  contact varchar
  email varchar
}

Table place_contact_websites {
  place_contact_id bigint [ref: > place_contact.id]
  website varchar
}

Table place_location {
  id bigint [pk, increment]
  place_id bigint [unique, ref: - place_info.id]
  address varchar
  latitude decimal
  longitude decimal
}

Table place_parking {
  id bigint [pk, increment]
  place_id bigint [unique, ref: - place_info.id]
  available_parking_lots int
  parking_type varchar
}

Table place_image {
  image_id bigint [pk, increment]
  place_id bigint [ref: > place_info.id]
  image_url varchar
  sequence int
}

Table place_keyword {
  id bigint [pk, increment]
  name varchar [unique]
}

Table place_keywords {
  place_id bigint [pk, ref: > place_info.id]
  keyword_id bigint [pk, ref: > place_keyword.id]
}

// ============================================
// ROOM INFO SERVICE
// ============================================

Table room_info {
  room_id bigint [pk, note: 'Snowflake ID']
  place_id bigint [ref: > place_info.id, note: 'Place 서비스 참조 - 1:N 관계']
  room_name varchar
  status varchar
  time_slot varchar
  max_occupancy int
  created_at timestamp
  updated_at timestamp
}

Table room_image {
  image_id bigint [pk, increment]
  room_id bigint [ref: > room_info.room_id]
  image_url varchar
  sequence int
}

Table further_detail {
  id bigint [pk, increment]
  room_id bigint [ref: > room_info.room_id]
  detail varchar
}

Table caution_detail {
  id bigint [pk, increment]
  room_id bigint [ref: > room_info.room_id]
  detail varchar
}

Table room_options_mapper {
  id bigint [pk, increment]
  room_id bigint [ref: > room_info.room_id]
  option_name varchar
}

Table reservation_field {
  field_id bigint [pk, increment]
  room_id bigint [ref: > room_info.room_id]
  title varchar
  input_type varchar
  required boolean
  max_length int
  sequence int
}

// ============================================
// ROOM OPERATING POLICY SERVICE
// ============================================

Table room_operating_policy {
  id bigint [pk, increment]
  room_id bigint [ref: > room_info.room_id, note: 'Room 서비스 참조']
  day_of_week varchar
  start_time time
  end_time time
  is_active boolean
}

Table room_time_slot {
  slot_id bigint [pk, increment]
  room_id bigint [ref: > room_info.room_id, note: 'Room 서비스 참조']
  reservation_id bigint [ref: > reservation.reservation_id, note: 'Reservation 서비스 참조']
  slot_date date
  start_time time
  end_time time
  status varchar [note: 'AVAILABLE, BOOKED, BLOCKED']
}

// ============================================
// PRODUCT SERVICE
// ============================================

Table product {
  id bigint [pk, note: 'Snowflake ID']
  scope varchar [note: 'PLACE, ROOM']
  place_id bigint [ref: > place_info.id, note: 'Place 서비스 참조']
  room_id bigint [ref: > room_info.room_id, note: 'Room 서비스 참조 (nullable)']
  name varchar
  pricing_strategy_type varchar
  pricing_strategy_value decimal
  total_quantity int
  reserved_quantity int
  created_at timestamp
}

Table pricing_policy {
  id bigint [pk, increment]
  product_id bigint [ref: > product.id]
  condition_type varchar
  condition_value varchar
  price_adjustment decimal
}

Table room_allowed_product {
  room_id bigint [pk, ref: > room_info.room_id]
  product_id bigint [pk, ref: > product.id]
}

// ============================================
// RESERVATION SERVICE (핵심 트랜잭션)
// ============================================

Table reservation {
  reservation_id bigint [pk, note: 'Snowflake ID - 결제/리뷰/쿠폰에서 참조']
  place_id bigint [ref: > place_info.id, note: 'Place 서비스 참조']
  room_id bigint [ref: > room_info.room_id, note: 'Room 서비스 참조']
  user_id varchar [ref: > auth.id, note: '예약자 - Auth 서비스 참조']
  status varchar [note: 'PENDING, CONFIRMED, APPROVED, REJECTED, CANCELLED, COMPLETED']
  reservation_date date
  total_price decimal
  reservation_time_price decimal
  reserver_name varchar [note: '암호화']
  reserver_phone varchar [note: '암호화']
  approved_at timestamp
  approved_by varchar [ref: > auth.id, note: '승인자 - Auth 서비스 참조']
  rejected_at timestamp
  rejected_reason varchar
  rejected_by varchar [ref: > auth.id, note: '거절자 - Auth 서비스 참조']
  created_at timestamp
  updated_at timestamp

  Indexes {
    (room_id, reservation_date)
    (user_id, status)
    (place_id, status)
  }
}

Table reservation_start_times {
  reservation_id bigint [ref: > reservation.reservation_id]
  start_time time
}

Table reservation_product_data {
  reservation_id bigint [ref: > reservation.reservation_id]
  product_key varchar
  product_value varchar
}

Table reservation_additional_info {
  reservation_id bigint [ref: > reservation.reservation_id]
  info_key varchar
  info_value varchar
}

Table blacklist {
  id bigint [pk, increment]
  user_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  place_id bigint [ref: > place_info.id, note: 'Place 서비스 참조']
  reason varchar
  blacklisted_at timestamp
  blacklisted_by varchar [ref: > auth.id]

  Indexes {
    (user_id, place_id) [unique]
  }
}

// ============================================
// COUPON SERVICE
// ============================================

Table coupon_policy {
  id bigint [pk, note: 'Snowflake ID']
  coupon_name varchar
  coupon_code varchar [unique]
  description text
  discount_type varchar
  discount_value decimal
  max_discount_amount decimal
  minimum_order_amount decimal
  applicable_rule jsonb
  distribution_type varchar
  valid_from timestamp
  valid_until timestamp
  max_issue_count int
  max_usage_per_user int
  current_issue_count int
  is_active boolean
  created_by varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  version bigint
  created_at timestamp
}

Table coupon_issue {
  id bigint [pk, increment]
  policy_id bigint [ref: > coupon_policy.id]
  user_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  status varchar [note: 'ISSUED, USED, EXPIRED, CANCELLED']
  issued_at timestamp
  used_at timestamp
  reservation_id bigint [ref: > reservation.reservation_id, note: 'Reservation 서비스 참조']

  Indexes {
    (user_id, policy_id)
  }
}

Table coupon_reservation {
  id bigint [pk, increment]
  policy_id bigint [ref: > coupon_policy.id]
  user_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  reservation_id bigint [ref: > reservation.reservation_id, note: 'Reservation 서비스 참조']
  reserved_at timestamp
  expires_at timestamp
}

Table coupon_statistics {
  id bigint [pk, increment]
  policy_id bigint [ref: > coupon_policy.id]
  total_issued int
  total_used int
  total_amount_discounted decimal
  calculated_at timestamp
}

// ============================================
// PAYMENT SERVICE
// ============================================

Table payment {
  payment_id bigint [pk, note: 'Snowflake ID']
  reservation_id bigint [unique, ref: - reservation.reservation_id, note: 'Reservation 서비스 1:1 참조']
  amount_value decimal
  amount_currency varchar [default: 'KRW']
  method varchar [note: 'CARD, BANK_TRANSFER, VIRTUAL_ACCOUNT']
  status varchar [note: 'PENDING, PAID, CANCELLED, REFUNDED, FAILED']
  order_id varchar [unique]
  payment_key varchar
  transaction_id varchar
  idempotency_key varchar [unique]
  paid_at timestamp
  cancelled_at timestamp
  failure_reason varchar
  created_at timestamp
}

Table payment_event {
  id bigint [pk, increment]
  payment_id bigint [ref: > payment.payment_id]
  event_type varchar
  event_data jsonb
  occurred_at timestamp
}

Table refund {
  id bigint [pk, increment]
  payment_id bigint [ref: > payment.payment_id]
  refund_amount decimal
  reason varchar
  status varchar
  refunded_at timestamp
  processed_by varchar [ref: > auth.id, note: 'Auth 서비스 참조']
}

// ============================================
// BOARD SERVICE
// ============================================

Table board {
  id bigint [pk, increment]
  name varchar [unique]
  description text
  is_active boolean
  display_order int
  created_at timestamp
}

Table article {
  id varchar [pk, note: 'Snowflake ID - Comment/Activity에서 참조']
  board_id bigint [ref: > board.id]
  article_type varchar [note: 'REGULAR, EVENT, NOTICE']
  title varchar
  content text
  writer_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  first_image_url varchar
  view_count bigint
  status varchar
  version bigint
  event_start_date date
  event_end_date date
  created_at timestamp
  updated_at timestamp

  Indexes {
    (board_id, status)
    (writer_id)
  }
}

Table article_image {
  id varchar [pk]
  article_id varchar [ref: > article.id]
  image_url varchar
  sequence int
}

Table board_keyword {
  id bigint [pk, increment]
  board_id bigint [ref: > board.id]
  name varchar
  usage_count bigint

  Indexes {
    (board_id, name) [unique]
  }
}

Table keyword_mapping {
  article_id varchar [pk, ref: > article.id]
  keyword_id bigint [pk, ref: > board_keyword.id]
}

// ============================================
// COMMENT SERVICE
// ============================================

Table comment {
  comment_id varchar [pk]
  article_id varchar [ref: > article.id, note: 'Article 서비스 참조']
  writer_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  parent_comment_id varchar [ref: > comment.comment_id, note: '자기 참조 - 대댓글']
  root_comment_id varchar [ref: > comment.comment_id, note: '자기 참조 - 스레드']
  depth int
  contents text
  is_deleted boolean
  status varchar
  reply_count int
  created_at timestamp
  updated_at timestamp
  deleted_at timestamp

  Indexes {
    (article_id, created_at)
    (root_comment_id, depth)
    (writer_id)
  }
}

// ============================================
// LIKES SERVICE (GaeChu)
// ============================================

Table like_categories {
  id bigint [pk, increment]
  category_name varchar [unique, note: 'ARTICLE, COMMENT, PLACE, ROOM']
}

Table likes {
  like_id varchar [pk]
  category_id bigint [ref: > like_categories.id]
  reference_id varchar [note: '동적 참조 - Article/Comment/Place/Room ID']
  liker_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  liked_at timestamp

  Indexes {
    (category_id, reference_id, liker_id) [unique]
  }
}

Table like_count {
  category_id bigint [pk, ref: > like_categories.id]
  reference_id varchar [pk]
  count bigint
}

// ============================================
// HOT ARTICLE SERVICE
// ============================================

Table article_score {
  id bigint [pk, increment]
  article_id varchar [unique, ref: > article.id, note: 'Article 서비스 참조']
  score double
  view_count bigint
  like_count bigint
  comment_count bigint
  calculated_at timestamp
}

// ============================================
// ACTIVITY SERVICE
// ============================================

Table user_article {
  user_id varchar [pk, ref: > auth.id, note: 'Auth 서비스 참조']
  article_id varchar [pk, ref: > article.id, note: 'Article 서비스 참조']
  title varchar
  version bigint
  created_at timestamp
}

Table user_like {
  user_id varchar [pk, ref: > auth.id, note: 'Auth 서비스 참조']
  category_id bigint [pk]
  reference_id varchar [pk]
  liked_at timestamp
}

Table user_comment {
  user_id varchar [pk, ref: > auth.id, note: 'Auth 서비스 참조']
  comment_id varchar [pk, ref: > comment.comment_id, note: 'Comment 서비스 참조']
  article_id varchar [ref: > article.id, note: 'Article 서비스 참조']
  created_at timestamp
}

Table user_board_activities_count {
  user_id varchar [pk, ref: > auth.id, note: 'Auth 서비스 참조']
  article_count int
  comment_count int
  like_count int
  updated_at timestamp
}

// ============================================
// CHAT SERVICE (MongoDB)
// ============================================

Table chat_room {
  id bigint [pk, note: 'MongoDB _id']
  type varchar [note: 'DIRECT, GROUP, SUPPORT']
  name varchar
  owner_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  status varchar
  created_at timestamp
  last_message_at timestamp

  note: 'MongoDB Collection'
}

Table chat_participant {
  room_id bigint [ref: > chat_room.id]
  user_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  joined_at timestamp
  role varchar

  note: 'MongoDB Embedded'
}

Table chat_message {
  id bigint [pk]
  room_id bigint [ref: > chat_room.id]
  sender_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  content text
  created_at timestamp

  note: 'MongoDB Collection'
}

Table message_read_by {
  message_id bigint [ref: > chat_message.id]
  user_id varchar [ref: > auth.id]
  read_at timestamp

  note: 'MongoDB Embedded Map'
}

// ============================================
// REVIEW SERVICE (MongoDB)
// ============================================

Table review {
  id varchar [pk, note: 'reservationId 사용']
  reservation_id bigint [ref: - reservation.reservation_id, note: 'Reservation 서비스 1:1 참조']
  room_id bigint [ref: > room_info.room_id, note: 'Room 서비스 참조']
  place_id bigint [ref: > place_info.id, note: 'Place 서비스 참조']
  writer_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  rating int [note: '1-5']
  content text
  review_number bigint
  created_at timestamp

  note: 'MongoDB Collection'

  Indexes {
    (room_id, created_at)
    (place_id)
    (writer_id)
  }
}

Table place_rating {
  place_id bigint [pk, ref: > place_info.id, note: 'Place 서비스 참조']
  average_rating decimal
  total_reviews int
  rating_distribution jsonb
  updated_at timestamp

  note: 'MongoDB - 평점 집계'
}

// ============================================
// NOTIFICATION SERVICE
// ============================================

Table device_token {
  id bigint [pk, increment]
  user_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  token varchar
  platform varchar
  created_at timestamp
  updated_at timestamp

  Indexes {
    (user_id)
    (user_id, token) [unique]
  }
}

Table user_notification_consent {
  id bigint [pk, increment]
  user_id varchar [unique, ref: - auth.id, note: 'Auth 서비스 1:1 참조']
  push_enabled boolean
  email_enabled boolean
  sms_enabled boolean
  marketing_enabled boolean
  updated_at timestamp
}

// ============================================
// SUPPORT SERVICE
// ============================================

Table report {
  report_id varchar [pk]
  reporter_id varchar [ref: > auth.id, note: '신고자 - Auth 서비스 참조']
  reported_id varchar [note: '신고 대상 ID (동적)']
  reference_type varchar [note: 'USER, ARTICLE, COMMENT, PLACE, REVIEW']
  report_category varchar
  reason text
  status varchar
  reported_at timestamp

  Indexes {
    (reporter_id, reference_type, reported_id, status) [unique]
  }
}

Table report_category {
  reference_type varchar [pk]
  report_category varchar [pk]
  description varchar
}

Table report_history {
  id bigint [pk, increment]
  report_id varchar [ref: > report.report_id]
  status varchar
  processed_by varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  note text
  processed_at timestamp
}

Table sanction {
  id bigint [pk, increment]
  user_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  sanction_type varchar
  reason varchar
  duration_days int
  sanctioned_at timestamp
  sanctioned_by varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  expires_at timestamp
}

Table sanction_rule {
  id bigint [pk, increment]
  report_category varchar
  violation_count int
  sanction_type varchar
  duration_days int
}

Table inquiry {
  id bigint [pk, increment]
  user_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  category varchar
  title varchar
  content text
  status varchar
  created_at timestamp
}

Table answer {
  id bigint [pk, increment]
  inquiry_id bigint [ref: > inquiry.id]
  responder_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  content text
  answered_at timestamp
}

Table faq {
  id bigint [pk, increment]
  category varchar
  question varchar
  answer text
  display_order int
  is_active boolean
  created_at timestamp
}

// ============================================
// IMAGE SERVICE
// ============================================

Table image {
  id varchar [pk, note: 'Snowflake ID']
  reference_type_id bigint [ref: > image_reference_type.id]
  reference_id varchar [note: '동적 참조 ID']
  image_url varchar
  uploader_id varchar [ref: > auth.id, note: 'Auth 서비스 참조']
  status varchar
  is_deleted boolean
  created_at timestamp
}

Table image_reference_type {
  id bigint [pk, increment]
  type_name varchar [unique, note: 'ARTICLE, PLACE, ROOM, PROFILE']
}

Table storage_object {
  id varchar [pk, ref: - image.id]
  storage_location varchar
  origin_size bigint
  converted_size bigint
  origin_format_id bigint [ref: > extension.id]
  converted_format_id bigint [ref: > extension.id]
}

Table extension {
  id bigint [pk, increment]
  extension_name varchar [unique]
  mime_type varchar
}

// ============================================
// OUTBOX PATTERN (Event Publishing)
// ============================================

Table outbox_message {
  id bigint [pk, increment]
  aggregate_type varchar
  aggregate_id varchar
  event_type varchar
  payload jsonb
  status varchar [note: 'PENDING, PUBLISHED, FAILED']
  created_at timestamp
  published_at timestamp
  retry_count int

  Indexes {
    (status, created_at)
  }
}

// ============================================
// TABLE GROUPS BY SERVICE
// ============================================

TableGroup core_auth [color: #e74c3c] {
  auth
  auth_consent
  consents_table
  auth_history
  withdraw
  suspend
  login_status
}

TableGroup profile [color: #9b59b6] {
  user_info
  user_genres
  genre_name_table
  user_instruments
  instrument_name_table
}

TableGroup place [color: #3498db] {
  place_info
  place_contact
  place_contact_websites
  place_location
  place_parking
  place_image
  place_keyword
  place_keywords
}

TableGroup room [color: #2ecc71] {
  room_info
  room_image
  further_detail
  caution_detail
  room_options_mapper
  reservation_field
}

TableGroup room_operation [color: #1abc9c] {
  room_operating_policy
  room_time_slot
}

TableGroup product_pricing [color: #f39c12] {
  product
  pricing_policy
  room_allowed_product
}

TableGroup reservation_core [color: #e67e22] {
  reservation
  reservation_start_times
  reservation_product_data
  reservation_additional_info
  blacklist
}

TableGroup coupon [color: #d35400] {
  coupon_policy
  coupon_issue
  coupon_reservation
  coupon_statistics
}

TableGroup payment [color: #c0392b] {
  payment
  payment_event
  refund
}

TableGroup board [color: #8e44ad] {
  board
  article
  article_image
  board_keyword
  keyword_mapping
}

TableGroup comment_service [color: #2980b9] {
  comment
}

TableGroup likes [color: #27ae60] {
  like_categories
  likes
  like_count
}

TableGroup hot_article [color: #16a085] {
  article_score
}

TableGroup activity [color: #f1c40f] {
  user_article
  user_like
  user_comment
  user_board_activities_count
}

TableGroup chat_mongodb [color: #95a5a6] {
  chat_room
  chat_participant
  chat_message
  message_read_by
}

TableGroup review_mongodb [color: #7f8c8d] {
  review
  place_rating
}

TableGroup notification [color: #34495e] {
  device_token
  user_notification_consent
}

TableGroup support [color: #2c3e50] {
  report
  report_category
  report_history
  sanction
  sanction_rule
  inquiry
  answer
  faq
}

TableGroup image_storage [color: #bdc3c7] {
  image
  image_reference_type
  storage_object
  extension
}

TableGroup event_outbox [color: #ecf0f1] {
  outbox_message
}
